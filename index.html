<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Passport Photo Sheet Maker</title>
  <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css" />
  <style>
    :root{--bg:#0b1020;--panel:#121732;--muted:#9fb0d0;--accent:#4ade80;--danger:#ef476f}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:#0b1020; color:#fff; margin:0}
    header{padding:12px; background:#121732; display:flex; justify-content:space-between; align-items:center; gap:10px}
    h1{margin:0; font-size:18px}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    .btn{background:#1b2147; border:1px solid #3b4482; padding:8px 12px; border-radius:10px; color:#fff; cursor:pointer; font-weight:600; font-size:13px}
    .btn.primary{background:linear-gradient(135deg,#3fb2ff,#4ade80); color:#04121b; border:0}
    .btn.danger{background:var(--danger); border:0}
    .btn[disabled]{opacity:.55; cursor:not-allowed}
    main{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; padding:14px; height: calc(100vh - 58px)}
    #imageHolder{ background:#0f1330; border:1px solid #2a3169; border-radius:12px; display:flex; align-items:center; justify-content:center; min-height:420px}
    #image{max-width:100%; max-height:78vh; display:block}
    .card{background:#10163b; border:1px solid #2a3169; border-radius:12px; padding:12px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:6px 0}
    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .label{font-size:12px; color:var(--muted)}
    input[type="range"]{width:100%}
    .val{font-variant-numeric: tabular-nums; color:#bcd1ff; font-weight:700}
  </style>
</head>
<body>
  <header>
    <h1>Passport Photo Sheet Maker</h1>
    <div class="toolbar">
      <label class="btn"><input id="fileInput" type="file" accept="image/*" style="display:none"/>Upload</label>
      <button id="startCropBtn" class="btn">Start Crop</button>
      <button id="applyCropBtn" class="btn">Apply Crop</button>
      <button id="rotateBtn" class="btn">Rotate 90°</button>
      <button id="resetBtn" class="btn danger">Reset</button>
      <button id="generateBtn" class="btn primary">Create PDF</button>
    </div>
  </header>

  <main>
    <section class="card">
      <div id="imageHolder"><img id="image" alt="Upload to start"/></div>
      <div class="row" style="justify-content:space-between"><span class="label">Preview with live adjustments</span><span class="label">Crop → Apply Crop removes the old selection and locks the result.</span></div>
    </section>

    <aside class="card">
      <div class="grid">
        <div>
          <div class="label">Brightness <span id="bVal" class="val">100%</span></div>
          <input id="brightness" type="range" min="50" max="150" value="100"/>
        </div>
        <div>
          <div class="label">Contrast <span id="cVal" class="val">100%</span></div>
          <input id="contrast" type="range" min="50" max="150" value="100"/>
        </div>
        <div>
          <div class="label">Gamma <span id="gVal" class="val">1.00</span></div>
          <input id="gamma" type="range" min="70" max="180" value="100"/>
        </div>
        <div>
          <div class="label">Size preset</div>
          <select id="sizePreset">
            <option value="35x45">Passport 35×45 mm</option>
            <option value="25x35">Passport 25×35 mm</option>
            <option value="35x35">Passport 35×35 mm</option>
            <option value="50x50">US 2×2 in (50×50 mm)</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div>
          <div class="label">W (mm)</div>
          <input id="imgW" type="number" step="0.1" value="35"/>
        </div>
        <div>
          <div class="label">H (mm)</div>
          <input id="imgH" type="number" step="0.1" value="45"/>
        </div>
      </div>
      <div class="row"><span class="label">DPI</span><input id="dpi" type="number" value="300" min="72" max="900" style="width:90px"></div>
      <div class="row"><label class="label"><input id="cutMarks" type="checkbox" checked/> Cutting marks</label><label class="label"><input id="border" type="checkbox"/> Border</label></div>
      <div class="row"><label class="label"><input id="inc4x6" type="checkbox" checked/> 4×6 page</label><label class="label"><input id="inc5x7" type="checkbox" checked/> 5×7 page</label></div>
    </aside>
  </main>

  <script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script>
    const mmPerInch=25.4; const $=id=>document.getElementById(id);
    let cropper=null; const imageEl=$('image');

    const presets={"25x35":[25,35],"35x35":[35,35],"35x45":[35,45],"50x50":[50,50]};

    function updateLabels(){ $('bVal').textContent=$('brightness').value+'%'; $('cVal').textContent=$('contrast').value+'%'; $('gVal').textContent=(+$('gamma').value/100).toFixed(2); }
    function applyPreviewFilters(){ imageEl.style.filter=`brightness(${$('brightness').value}%) contrast(${$('contrast').value}%)`; }

    function startCrop(){ if(!imageEl.src) return alert('Upload first'); if(cropper) cropper.destroy(); cropper=new Cropper(imageEl,{viewMode:1,autoCropArea:0.92,background:false}); }
    function applyCrop(){ if(!cropper) return alert('Start crop first'); const c=cropper.getCroppedCanvas(); imageEl.src=c.toDataURL('image/jpeg',0.95); cropper.destroy(); cropper=null; }

    function rotate90(){ if(cropper){ cropper.rotate(90); return; } if(!imageEl.src) return; const tmp=new Image(); tmp.onload=()=>{ const cvs=document.createElement('canvas'); cvs.width=tmp.height; cvs.height=tmp.width; const ctx=cvs.getContext('2d'); ctx.translate(cvs.width/2,cvs.height/2); ctx.rotate(Math.PI/2); ctx.drawImage(tmp,-tmp.width/2,-tmp.height/2); imageEl.src=cvs.toDataURL('image/jpeg',0.95);} ; tmp.src=imageEl.src; }

    function getProcessedCanvas(targetWpx,targetHpx){
      return new Promise((resolve)=>{
        const img=new Image(); img.onload=()=>{
          const cvs=document.createElement('canvas'); cvs.width=targetWpx; cvs.height=targetHpx; const ctx=cvs.getContext('2d');
          // apply brightness/contrast via canvas filter; gamma later
          ctx.filter=`brightness(${$('brightness').value}%) contrast(${$('contrast').value}%)`;
          ctx.drawImage(img,0,0,targetWpx,targetHpx);
          const gamma=+$('gamma').value/100; if(Math.abs(gamma-1)>0.01){ const id=ctx.getImageData(0,0,cvs.width,cvs.height); const d=id.data; const inv=1/gamma; const lut=new Uint8ClampedArray(256); for(let i=0;i<256;i++){ lut[i]=Math.min(255,Math.round(255*Math.pow(i/255,inv))); } for(let i=0;i<d.length;i+=4){ d[i]=lut[d[i]]; d[i+1]=lut[d[i+1]]; d[i+2]=lut[d[i+2]]; } ctx.putImageData(id,0,0);} resolve(cvs);
        }; img.src=imageEl.src;
      });
    }

    function placeOnPDF(doc,pw,ph,imgWmm,imgHmm){
      const gap=3, margin=4; const cut=$('cutMarks').checked; const border=$('border').checked;
      const cols=Math.max(1,Math.floor((pw-2*margin+gap)/(imgWmm+gap))); const rows=Math.max(1,Math.floor((ph-2*margin+gap)/(imgHmm+gap)));
      const startX=margin, startY=margin;
      return async (dataURL)=>{
        let k=0; for(let r=0;r<rows;r++){ for(let c=0;c<cols;c++){ const x=startX+c*(imgWmm+gap); const y=startY+r*(imgHmm+gap); doc.addImage(dataURL,'JPEG',x,y,imgWmm,imgHmm,'','FAST'); if(border){ doc.setDrawColor(0); doc.setLineWidth(0.2); doc.rect(x,y,imgWmm,imgHmm);} if(cut){ doc.setDrawColor(160); doc.setLineWidth(0.15); const m=2.5; doc.line(x-m,y,x,y); doc.line(x,y-m,x,y); doc.line(x+imgWmm,y,x+imgWmm+m,y); doc.line(x+imgWmm,y,x+imgWmm,y-m); doc.line(x-m,y+imgHmm,x,y+imgHmm); doc.line(x,y+imgHmm,x,y+imgHmm+m); doc.line(x+imgWmm,y+imgHmm,x+imgWmm+m,y+imgHmm); doc.line(x+imgWmm,y+imgHmm,x+imgWmm,y+imgHmm+m);} k++; } }
      }
    }

    // Events
    $('fileInput').addEventListener('change',e=>{ const f=e.target.files?.[0]; if(!f) return; const url=URL.createObjectURL(f); imageEl.src=url; imageEl.onload=()=>{ if(cropper){ cropper.destroy(); cropper=null;} }; });
    $('startCropBtn').addEventListener('click',startCrop);
    $('applyCropBtn').addEventListener('click',applyCrop);
    $('rotateBtn').addEventListener('click',rotate90);
    $('resetBtn').addEventListener('click',()=>{ if(cropper){ cropper.destroy(); cropper=null;} imageEl.style.filter=''; $('brightness').value=100; $('contrast').value=100; $('gamma').value=100; updateLabels(); });

    ;['brightness','contrast','gamma'].forEach(id=>$(id).addEventListener('input',()=>{updateLabels(); applyPreviewFilters();}));
    $('sizePreset').addEventListener('change',()=>{ const v=$('sizePreset').value; if(presets[v]){ const [w,h]=presets[v]; $('imgW').value=w; $('imgH').value=h; }});

    updateLabels();

    document.getElementById('generateBtn').addEventListener('click', async ()=>{
      if(!imageEl.src) return alert('Upload and crop/apply first');
      // target px for selected size (based on DPI)
      const dpi=parseInt($('dpi').value)||300; const wmm=parseFloat($('imgW').value)||35; const hmm=parseFloat($('imgH').value)||45; const wp=Math.round(wmm*dpi/mmPerInch); const hp=Math.round(hmm*dpi/mmPerInch);
      const processed=await getProcessedCanvas(wp,hp); const dataURL=processed.toDataURL('image/jpeg',0.95);
      const { jsPDF } = window.jspdf; let doc=null; let first=true; function addPage(pw,ph){ if(first){ doc=new jsPDF({unit:'mm',format:[pw,ph],orientation: pw>ph?'landscape':'portrait'}); first=false;} else { doc.addPage([pw,ph], pw>ph?'landscape':'portrait'); } return placeOnPDF(doc,pw,ph,wmm,hmm); }
      if($('inc4x6').checked){ const act=await addPage(102,152); await act(dataURL); }
      if($('inc5x7').checked){ const act=await addPage(127,178); await act(dataURL); }
      if(!doc){ alert('Select at least one page'); return; }
      doc.save('passport_sheet.pdf');
    });
  </script>
</body>
</html>
